name: List Repos by Suborg

on:
  workflow_dispatch:
    inputs:
      suborg:
        description: 'Select a suborg to list repositories'
        required: true
        type: choice
        options:
          - automation
          - cs
          - database
          - esl
          - guardians
          - guest
          - Hybris
          - iam
          - loyalty
          - payment
          - platform
          - shipboard
          - ssh
          - unassigned

jobs:
  list-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: List repositories for suborg
        env:
          GH_TOKEN: ${{ secrets.COMMONS_ORG_PAT }}
          SUBORG: ${{ github.event.inputs.suborg }}
        run: |
          ORG="rcg-digital-backend"
          
          echo "Fetching all repositories from $ORG..."
          gh repo list "$ORG" --limit 1500 --json name -q '.[].name' | sort > all-repos.txt
          
          if [ "$SUBORG" == "unassigned" ]; then
            echo "Finding unassigned repositories..."
            
            # Collect all patterns from all suborg files
            > all-patterns.txt
            for file in .github/suborgs/*.yml; do
              yq eval '.suborgrepos[]' "$file" 2>/dev/null >> all-patterns.txt || true
            done
            
            # Filter repositories that don't match any pattern
            > matched-repos.txt
            while IFS= read -r repo; do
              matched=false
              while IFS= read -r pattern; do
                # Convert glob pattern to regex-like matching
                if [[ "$repo" == $pattern ]]; then
                  matched=true
                  break
                fi
              done < all-patterns.txt
              
              if [ "$matched" = false ]; then
                echo "$repo" >> matched-repos.txt
              fi
            done < all-repos.txt
            
            echo "Unassigned repositories (alphabetically sorted):" > repo-report.txt
            cat matched-repos.txt >> repo-report.txt
          else
            echo "Processing suborg: $SUBORG"
            SUBORG_FILE=".github/suborgs/${SUBORG}.yml"
            
            if [ ! -f "$SUBORG_FILE" ]; then
              echo "Error: Suborg file not found: $SUBORG_FILE" > repo-report.txt
              exit 1
            fi
            
            # Extract suborgrepos patterns from the YAML file
            yq eval '.suborgrepos[]' "$SUBORG_FILE" > patterns.txt
            
            # Match repositories against patterns
            > matched-repos.txt
            while IFS= read -r repo; do
              while IFS= read -r pattern; do
                if [[ "$repo" == $pattern ]]; then
                  echo "$repo" >> matched-repos.txt
                  break
                fi
              done < patterns.txt
            done < all-repos.txt
            
            # Sort and output
            echo "Repositories matching suborg '$SUBORG' (alphabetically sorted):" > repo-report.txt
            sort matched-repos.txt >> repo-report.txt
          fi
          
          echo "Results:"
          cat repo-report.txt
      
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: repos-${{ github.event.inputs.suborg }}
          path: repo-report.txt
